/* global atom */

"use strict";

var WordCountView = require("./word-count-view");
var CompositeDisposable = require("atom").CompositeDisposable;

var WordCount = {

  wordCountView: null,
  modalPanel: null,
  subscriptions: null,

  activate: function activate(state) {

    this.wordCountView = new WordCountView(state.wordCountViewState);

    this.modalPanel = atom.workspace.addModalPanel({
      item: this.wordCountView.getElement(),
      visible: false
    });

    this.subscriptions = new CompositeDisposable();

    return this.subscriptions.add(atom.commands.add("atom-workspace", {
      "word-count:toggle": (function (_this) {
        return function () {
          return _this.toggle();
        };
      })(this)
    }));
  },

  deactivate: function deactivate() {
    this.modalPanel.destroy();
    this.subscriptions.dispose();
    this.wordCountView.destroy();
  },

  serialize: function serialize() {
    return {
      wordCountViewState: this.wordCountView.serialize()
    };
  },

  toggle: function toggle() {
    if (this.modalPanel.isVisible()) {
      return this.hide();
    } else {
      return this.show();
    }
  },

  hide: function hide() {
    this.disposableItem && this.disposableItem.dispose();
    this.modalPanel.hide();
  },

  calculate: function calculate() {
    var words;
    words = this.getCurrentText().split(/\s+/).length;
    this.wordCountView.setCount(words);
  },

  show: function show() {
    // get editor
    var editor = atom.workspace.getActiveTextEditor();
    if (!editor) {
      return;
    }

    this.calculate();
    this.modalPanel.show();
    if (this.disposableItem === void 0 || this.disposableItem.disposed) {
      this.disposableItem = editor.onDidChangeSelectionRange((function (_this) {
        return function () {
          return _this.calculate();
        };
      })(this));
    }
  },

  getCurrentText: function getCurrentText() {
    var selection, text;

    // get editor
    var editor = atom.workspace.getActiveTextEditor();
    if (!editor) {
      return "";
    }

    selection = editor.getSelectedText();
    text = editor.getText();
    return selection || text;
  }
};

module.exports = WordCount;
//# sourceMappingURL=data:application/json;base64,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QUMseUJBQXlCLENBQUMsQ0FBQyxVQUFTLEtBQUssRUFBRTtBQUN0RSxlQUFPLFlBQVc7QUFDaEIsaUJBQU8sS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQzFCLENBQUM7T0FDSCxDQUFBLENBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztLQUNYO0dBQ0Y7O0FBRUQsZ0JBQWMsRUFBRSwwQkFBVztBQUN6QixRQUFJLFNBQVMsRUFBRSxJQUFJLENBQUM7OztBQUdwQixRQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7QUFDbEQsUUFBSSxDQUFDLE1BQU0sRUFBRTtBQUNYLGFBQU8sRUFBRSxDQUFDO0tBQ1g7O0FBRUQsYUFBUyxHQUFHLE1BQU0sQ0FBQyxlQUFlLEVBQUUsQ0FBQztBQUNyQyxRQUFJLEdBQUcsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ3hCLFdBQU8sU0FBUyxJQUFJLElBQUksQ0FBQztHQUMxQjtDQUNGLENBQUM7O0FBRUYsTUFBTSxDQUFDLE9BQU8sR0FBRyxTQUFTLENBQUMiLCJmaWxlIjoid29yZC1jb3VudC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGdsb2JhbCBhdG9tICovXG5cbnZhciBXb3JkQ291bnRWaWV3ID0gcmVxdWlyZSgnLi93b3JkLWNvdW50LXZpZXcnKTtcbnZhciBDb21wb3NpdGVEaXNwb3NhYmxlID0gcmVxdWlyZSgnYXRvbScpLkNvbXBvc2l0ZURpc3Bvc2FibGU7XG5cbnZhciBXb3JkQ291bnQgPSB7XG5cbiAgd29yZENvdW50VmlldzogbnVsbCxcbiAgbW9kYWxQYW5lbDogbnVsbCxcbiAgc3Vic2NyaXB0aW9uczogbnVsbCxcblxuICBhY3RpdmF0ZTogZnVuY3Rpb24oc3RhdGUpIHtcblxuICAgIHRoaXMud29yZENvdW50VmlldyA9IG5ldyBXb3JkQ291bnRWaWV3KHN0YXRlLndvcmRDb3VudFZpZXdTdGF0ZSk7XG5cbiAgICB0aGlzLm1vZGFsUGFuZWwgPSBhdG9tLndvcmtzcGFjZS5hZGRNb2RhbFBhbmVsKHtcbiAgICAgIGl0ZW06IHRoaXMud29yZENvdW50Vmlldy5nZXRFbGVtZW50KCksXG4gICAgICB2aXNpYmxlOiBmYWxzZVxuICAgIH0pO1xuXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcblxuICAgIHJldHVybiB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXdvcmtzcGFjZScsIHtcbiAgICAgICd3b3JkLWNvdW50OnRvZ2dsZSc6IChmdW5jdGlvbihfdGhpcykge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgcmV0dXJuIF90aGlzLnRvZ2dsZSgpO1xuICAgICAgICB9O1xuICAgICAgfSkodGhpcylcbiAgICB9KSk7XG4gIH0sXG5cbiAgZGVhY3RpdmF0ZTogZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5tb2RhbFBhbmVsLmRlc3Ryb3koKTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZGlzcG9zZSgpO1xuICAgIHRoaXMud29yZENvdW50Vmlldy5kZXN0cm95KCk7XG4gIH0sXG5cbiAgc2VyaWFsaXplOiBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4ge1xuICAgICAgd29yZENvdW50Vmlld1N0YXRlOiB0aGlzLndvcmRDb3VudFZpZXcuc2VyaWFsaXplKClcbiAgICB9O1xuICB9LFxuXG4gIHRvZ2dsZTogZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMubW9kYWxQYW5lbC5pc1Zpc2libGUoKSkge1xuICAgICAgcmV0dXJuIHRoaXMuaGlkZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5zaG93KCk7XG4gICAgfVxuICB9LFxuXG4gIGhpZGU6IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZUl0ZW0gJiYgdGhpcy5kaXNwb3NhYmxlSXRlbS5kaXNwb3NlKCk7XG4gICAgdGhpcy5tb2RhbFBhbmVsLmhpZGUoKTtcbiAgfSxcblxuICBjYWxjdWxhdGU6IGZ1bmN0aW9uKCkge1xuICAgIHZhciB3b3JkcztcbiAgICB3b3JkcyA9IHRoaXMuZ2V0Q3VycmVudFRleHQoKS5zcGxpdCgvXFxzKy8pLmxlbmd0aDtcbiAgICB0aGlzLndvcmRDb3VudFZpZXcuc2V0Q291bnQod29yZHMpO1xuICB9LFxuXG4gIHNob3c6IGZ1bmN0aW9uKCkge1xuICAgIC8vIGdldCBlZGl0b3JcbiAgICB2YXIgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuICAgIGlmICghZWRpdG9yKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5jYWxjdWxhdGUoKTtcbiAgICB0aGlzLm1vZGFsUGFuZWwuc2hvdygpO1xuICAgIGlmICh0aGlzLmRpc3Bvc2FibGVJdGVtID09PSB2b2lkIDAgfHxcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlSXRlbS5kaXNwb3NlZCkge1xuICAgICAgdGhpcy5kaXNwb3NhYmxlSXRlbSA9IGVkaXRvci5vbkRpZENoYW5nZVNlbGVjdGlvblJhbmdlKChmdW5jdGlvbihfdGhpcykge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgcmV0dXJuIF90aGlzLmNhbGN1bGF0ZSgpO1xuICAgICAgICB9O1xuICAgICAgfSkodGhpcykpO1xuICAgIH1cbiAgfSxcblxuICBnZXRDdXJyZW50VGV4dDogZnVuY3Rpb24oKSB7XG4gICAgdmFyIHNlbGVjdGlvbiwgdGV4dDtcblxuICAgIC8vIGdldCBlZGl0b3JcbiAgICB2YXIgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuICAgIGlmICghZWRpdG9yKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgc2VsZWN0aW9uID0gZWRpdG9yLmdldFNlbGVjdGVkVGV4dCgpO1xuICAgIHRleHQgPSBlZGl0b3IuZ2V0VGV4dCgpO1xuICAgIHJldHVybiBzZWxlY3Rpb24gfHwgdGV4dDtcbiAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBXb3JkQ291bnQ7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
